# Overview
The `fpm_targets` module is responsible for translating the abstract project model (source files, dependencies, compiler options from `fpm_model_t`) into a concrete list of build targets. A "build target" (`build_target_t`) represents a specific file to be generated by the build system, such as an object file, an executable, a static library (archive), or a shared library. This module handles the creation of these targets, resolution of dependencies between them (particularly module dependencies), and determination of objects required for linking executables and libraries. It also implements logic for pruning unused module targets (tree-shaking) to optimize the build.

# Key Components
- **Target Type Enumerations**:
  - `FPM_TARGET_UNKNOWN`: Target type is unknown or ignored.
  - `FPM_TARGET_EXECUTABLE`: Target is an executable program.
  - `FPM_TARGET_ARCHIVE`: Target is a static library (archive).
  - `FPM_TARGET_OBJECT`: Target is a Fortran compiled object file.
  - `FPM_TARGET_C_OBJECT`: Target is a C compiled object file.
  - `FPM_TARGET_CPP_OBJECT`: Target is a C++ compiled object file.
  - `FPM_TARGET_SHARED`: Target is a shared library.
- **`build_target_t`**: A derived type representing a single build target.
  - `output_file`, `output_name`, `output_dir`, `output_log_file`: Paths and names related to the target's output.
  - `package_name`: Name of the parent package.
  - `source`: A `srcfile_t` object representing the primary source file for this target (if applicable).
  - `dependencies`: Array of `build_target_ptr`, listing other targets this one depends on.
  - `target_type`: Integer, one of `FPM_TARGET_*`.
  - `link_libraries`: Array of `string_t`, native libraries to link against.
  - `link_objects`: Array of `string_t`, object files needed to link this target.
  - `link_flags`, `compile_flags`: Character strings for linker and compiler flags.
  - `touched`, `sorted`, `skip`: Logical flags used during dependency sorting and pruning.
  - `features`: A `fortran_features_t` object.
  - `schedule`: Integer for build scheduling.
  - `digest_cached`: Cached hash of the source file.
  - `macros`: Array of `string_t` for preprocessor macros.
  - `version`: Character string for package version.
  - Procedures: `info`, `set_output_dir`, `is_executable_target`.
- **`build_target_ptr`**: A wrapper type `type(build_target_t), pointer :: ptr` used for creating arrays of pointers to `build_target_t`.
- **`targets_from_sources(targets, model, prune, library, error)`**: The main high-level subroutine that generates the full list of build targets from the `fpm_model_t`. It calls other subroutines to build the initial list, resolve dependencies, prune unused targets, and set up linking information.
- **`build_target_list(targets, model, library)`**: Constructs an initial list of targets based on source files in the `model`. It creates object targets for source files and archive/shared library/executable targets as appropriate.
- **`collect_exe_link_dependencies(targets)`**: Adds non-module dependencies for executables (e.g., object files from the same directory).
- **`resolve_module_dependencies(targets, external_modules, error)`**: Establishes dependencies between targets based on Fortran `USE` statements.
- **`prune_build_targets(targets, root_package, prune_unused_objects)`**: Removes targets that are not needed (e.g., modules not used by any executable or other used module), implementing tree-shaking.
- **`resolve_target_linking(targets, model, library, error)`**: Determines the final set of object files and libraries needed for linking each executable or library target and populates `link_flags` and `compile_flags` by incorporating global and target-specific settings.
- **`add_target` (interface)**: Generic interface for adding new targets to the list (either by creating a new one or adding an existing one).
  - `add_new_target(...)`: Creates a new target and adds it.
  - `add_old_target(...)`: Adds an existing `build_target_ptr` to the list.
- **`new_target(...)`**: Function to allocate and initialize a `build_target_ptr`.
- **`add_dependency(target, dependency)`**: Adds a dependency to a target's list.
- **Helper functions for filtering and path/flag generation**: `filter_library_targets`, `filter_executable_targets`, `filter_modules`, `get_output_dir`, `get_feature_flags`, `add_include_build_dirs`, `add_library_link_dirs`, `get_library_dirs`, `library_targets_to_deps`.

# Important Variables/Constants
- `FPM_TARGET_*` parameters: Define the different types of build outputs.
- The logic within `build_target_list` and `resolve_module_dependencies` that maps `srcfile_t%unit_type` and `srcfile_t%unit_scope` to specific target types and dependency rules is crucial.

# Usage Examples
This module is primarily used by the `fpm_backend` or a similar top-level build orchestration routine.
1. An `fpm_model_t` is populated by parsing manifests and source files.
2. `targets_from_sources` is called with this model.
3. The resulting `targets` array (of `build_target_ptr`) is then used by the backend:
   a. To sort targets topologically (`fpm_backend:sort_target`).
   b. To schedule parallel builds (`fpm_backend:schedule_targets`).
   c. To execute compilation/linking for each target (`fpm_backend:build_target`).

```fortran
! Conceptual Usage
use fpm_targets
use fpm_model
! ... other necessary modules ...

type(fpm_model_t) :: my_model
type(build_target_ptr), allocatable :: all_build_targets(:)
type(library_config_t) :: lib_config ! Assume populated
type(error_t), allocatable :: err
logical :: should_prune_targets = .true.

! (my_model is assumed to be fully populated here)

call targets_from_sources(all_build_targets, my_model, should_prune_targets, lib_config, err)
if (allocated(err)) then
    ! Handle error
else
    ! Pass all_build_targets to the build backend
end if
```

# Dependencies and Interactions
- **`iso_fortran_env`**: For `int64`, `stdout`.
- **`fpm_error`**: For error handling (`error_t`, `fatal_error`, `fpm_stop`).
- **`fpm_model`**: This is a primary dependency. `fpm_targets` consumes `fpm_model_t`, `srcfile_t`, `fortran_features_t`, and various constants (`FPM_UNIT_*`, `FPM_SCOPE_*`) from `fpm_model`.
- **`fpm_compiler`**: For `compiler_t` type and its methods like `get_main_flags`, `enumerate_libraries`, `get_feature_flag`, `get_module_flag`, `get_export_flags`. Used in `resolve_target_linking` and `add_include_build_dirs`.
- **`fpm_environment`**: For OS detection (`get_os_type`, `OS_WINDOWS`, `OS_MACOS`) and `library_filename`.
- **`fpm_filesystem`**: For path operations (`dirname`, `join_path`, `canon_path`).
- **`fpm_strings`**: For `string_t`, string operations (`.in.`, `string_cat`, `fnv_1a`, `resize`, `lower`, `str_ends_with`).
- **`fpm_sources`**: For `get_exe_name_with_suffix`.
- **`fpm_manifest_library`**: For `library_config_t` which influences how library targets are created and linked.
- **`fpm_manifest_preprocess`**: For `preprocess_config_t` (used to get macros for compile flags).
- **`fpm_backend`**: The output of this module (the `targets` array) is the primary input for the `fpm_backend` module, which executes the build.
The module's logic determines how source files are compiled into objects and how these objects are linked into final executables or libraries, including managing inter-module dependencies.
